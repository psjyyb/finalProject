<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/group/layouts/group_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>ARION</title>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
	integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
	crossorigin="anonymous">
<link rel="stylesheet" type="text/css"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
<link rel="stylesheet" type="text/css"
	th:href="@{/css/group/chat/chatStyle.css}">

</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<!-- Sidebar for chat rooms -->
			<div class="col-md-4 col-lg-3 sidebar">
				<div class="chat-rooms">
					<h4>Chat Rooms</h4>
					<ul id="chat-room-list" class="list-unstyled">
						<!-- Example chat rooms -->
						<li class="chat-room-item" th:each="room : ${chatRoomList}">
							<input type="hidden" th:value="${room.roomNo}">
							<div class="room-name">[[${room.chatroomName}]]</div>
							<div class="room-time">[[${#dates.format(room.createDate,'hh:mm')}]]</div></li>
					</ul>
					<button id="create-room" class="btn create-room-btn mt-3">Create
						Room</button>
				</div>
			</div>

			<!-- Main chat area -->
			<div class="col-md-8 col-lg-9">
				<div id="user_chat_data" class="user_chat_data">
					<div class="profile_name">
						&nbsp;&nbsp;&nbsp;&nbsp;<img src="./img/profile.png"
							class="mr-3 rounded-circle"> &nbsp;&nbsp; Sankar Mahadevan
					</div>
					<div class="container-fluid chat_section" id="chat-box">
						<!-- Received messages start -->
						<div class="incoming_msg" th:each="message : ${messages}">
							<div class="received_msg">
								<div class="received_withd_msg">
									<p>[[${message.content}]]</p>
									<span class="time_date"> 11:18 | Today</span>
								</div>
							</div>
						</div>
						<!-- Received messages end -->

						<!-- Sent messages start -->
						<!--  <div class="outgoing_msg">
                     <div class="sent_msg">
                        <p></p>
                        <span class="time_date"> 11:18 | Today</span>
                     </div>
                  </div> -->
						<!-- Sent messages end -->
					</div>

					<div class="type_msg">
						<div class="input_msg_write">
							<input id="chat-outgoing-msg" type="text" class="write_msg"
								placeholder="Type a message" />
							<button id="chat-send" class="msg_send_btn" type="button">
								<i class="fa fa-paper-plane" aria-hidden="true"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Custom Modal for creating a chat room -->
	<div id="createRoomModal" class="modal">
		<div class="modal-content">
			<span class="close">&times;</span>
			<h5>Create Chat Room</h5>
			<form id="create-room-form">
				<div class="form-group">
					<label for="room-name">Chat Room Name</label> <input type="text"
						class="form-control" id="room-name"
						placeholder="Enter chat room name" required>
				</div>
				<div class="form-group">
					<label for="employees">Select Employees</label>
					<div id="employee-list">
						<div th:each="emp : ${empList}">
							<input type="checkbox" th:id="'emp-' + ${emp.employeeNo}"
								th:name="employeeIds" th:value="${emp.employeeNo}" /> <label
								th:for="'emp-' + ${emp.employeeNo}"
								th:text="${emp.employeeName}"></label>
						</div>
					</div>
				</div>
				<button type="submit" class="btn btn-primary">Create Room</button>
			</form>
		</div>
	</div>

<script>
    let empNo = `[[${empNo}]]`;
    var stompClient = null;

    // 웹소켓 연결
    function connect() {
        var socket = new SockJS('/wsocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ', frame);
            stompClient.subscribe('/topic/messages', function (message) {
                var parsedMessage = JSON.parse(message.body);
                console.log(parsedMessage,'dkdkdkdkd');
                if(parsedMessage.senderId !=empNo){
                	 takeMessage(parsedMessage);
                }
               
            });
        });
    }

    function takeMessage(message) {
        var currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        var messageHtml = `
            <div class="incoming_msg">
                <div class="received_msg">
                    <div class="received_withd_msg">
                        <p>${message.content}</p>
                        <span class="time_date">${currentTime} | Today</span>
                    </div>
                </div>
            </div>
        `;
        $('#chat-box').append(messageHtml);
        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight); // Scroll to bottom
    }

    function sendMessage() {
        var messageContent = $('#chat-outgoing-msg').val();
        if (messageContent.trim() !== '') {
            var currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            var messageHtml = `
                <div class="outgoing_msg">
                    <div class="sent_msg">
                        <p>${messageContent}</p>
                        <span class="time_date">${currentTime} | Today</span>
                    </div>
                </div>
            `;
            $('#chat-box').append(messageHtml);
            $('#chat-outgoing-msg').val(''); // Clear input field
            $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight); // Scroll to bottom

            // Send message to WebSocket
            var message = {
                senderId: empNo,
                content: messageContent
            };
            stompClient.send("/app/chat", {}, JSON.stringify(message));
        }
    }

    $(document).ready(function () {
        // 웹소켓 연결 초기화
        connect();

        // 메시지 전송 버튼 클릭
        $('#chat-send').click(function () {
            sendMessage();
        });

        // 엔터 키로 메시지 전송
        $('#chat-outgoing-msg').keydown(function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 방 생성 버튼 클릭시 모달 보이기
        $('#create-room').click(function () {
            $('#createRoomModal').show();
        });

        // 모달 닫기 버튼 클릭시 모달 닫기
        $('.close').click(function () {
            $('#createRoomModal').hide();
        });

        // 모달 외부 클릭 시 모달 닫기
        $(window).click(function (event) {
            if ($(event.target).is('#createRoomModal')) {
                $('#createRoomModal').hide();
            }
        });

        // 채팅방 생성 폼 제출
        $('#create-room-form').on('submit', function (event) {
            event.preventDefault(); // 기본 폼 제출 방지

            var roomName = $('#room-name').val();

            // 체크된 사원 ID를 배열로 수집
            var selectedEmployees = [];
            $('#employee-list input[type="checkbox"]:checked').each(function () {
                selectedEmployees.push($(this).val());
            });

            var requestPayload = {
                chatroomName: roomName,
                employeeIds: selectedEmployees // 선택된 사원 ID 배열 추가
            };

            $.ajax({
                url: '/chat/chatrooms', // 서버의 채팅방 생성 URL
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestPayload),
                success: function (response) {
                    $('#createRoomModal').hide(); // 모달 숨기기
                    // 채팅방 목록 업데이트 등 추가 작업 가능
                    console.log(response,'결과값은 ? 뭐찍히지 ?');
                    addChatRoom(response);
                    
                },
                error: function () {
                    console.error('Failed to create chat room.');
                }
            });
        });
        // 방 생성후 동적으로 채팅방 추가.
        function addChatRoom(room) {
            var $newChatRoom = $('<li class="chat-room-item"></li>');

            var $roomNoInput = $('<input type="hidden">').val(room.roomNo);

            var $roomName = $('<div class="room-name"></div>').text(room.chatroomName);

            var date = new Date(room.createDate);
            var formattedTime = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
            var $roomTime = $('<div class="room-time"></div>').text(formattedTime);

            $newChatRoom.append($roomNoInput).append($roomName).append($roomTime);

            $('#chat-room-list').append($newChatRoom);
        }
    });
</script>

</body>
</html>