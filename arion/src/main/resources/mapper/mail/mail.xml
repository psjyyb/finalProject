<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.arion.app.group.main.mail.mapper.MailMapper">

<!-- 받은 메일 조회 -->
<select id="receiveMailAll" parameterType="map" resultType="MailVO">
    SELECT *
    FROM (
        SELECT mail_no, 
               sender_name,
               send_date,
               mail_title,
               ROWNUM AS rn
        FROM (
            SELECT m.mail_no, 
                   FIND_EMP_NAME(m.sender_id) AS sender_name,
                   m.send_date,
                   m.mail_title
            FROM mail m
            JOIN mail_receive mr ON m.mail_no = mr.mail_no
            WHERE mr.employee_id = #{mailVO.senderId}
            AND m.company_code = #{mailVO.companyCode}
            AND m.mail_status = 'RECEIVED'
            <if test="criteria.searchType != null and criteria.searchType != ''">
                <if test="criteria.searchType == 'mailtitle'">
                    AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
                </if>
                <if test="criteria.searchType == 'senderId'">
                    AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
                </if>
            </if>
            ORDER BY m.mail_no DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{criteria.pageNum} * #{criteria.amount}
    )
    WHERE rn > (#{criteria.pageNum} - 1) * #{criteria.amount}
</select>

<select id="selectMailTotalCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM mail m
    JOIN mail_receive mr ON m.mail_no = mr.mail_no
    WHERE mr.employee_id = #{mailVO.senderId}
    AND m.mail_status = #{mailVO.mailStatus}
    <if test="criteria.searchType != null and criteria.searchType != ''">
        <if test="criteria.searchType == 'mailtitle'">
            AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
        </if>
        <if test="criteria.searchType == 'senderId'">
            AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
        </if>
    </if>
</select>

<!-- 보낸 메일 조회 -->
<select id="sendMailAll" parameterType="map" resultType="MailVO">
			SELECT * 
FROM (
    SELECT ROWNUM AS rn, m.*
    FROM mail m
    WHERE m.sender_id = #{mailVO.senderId}
    AND m.mail_status = 'SEND'
    <if test="criteria.searchType != null and criteria.searchType != ''">
        <if test="criteria.searchType == 'mailtitle'">
            AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
        </if>
        <if test="criteria.searchType == 'senderId'">
            AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
        </if>
    </if>
    ORDER BY m.mail_no DESC
)
WHERE rn BETWEEN (#{criteria.pageNum} - 1) * #{criteria.amount} + 1 AND #{criteria.pageNum} * #{criteria.amount}
</select>

<select id="sendMailTotalCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM mail m
    JOIN mail_receive mr ON m.mail_no = mr.mail_no
    WHERE mr.employee_id = #{mailVO.senderId}
    AND m.mail_status = 'SEND'
    <if test="criteria.searchType != null and criteria.searchType != ''">
        <if test="criteria.searchType == 'mailtitle'">
            AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
        </if>
        <if test="criteria.searchType == 'senderId'">
            AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
        </if>
    </if>
</select>

<!-- 중요 메일 조회 -->
<select id="importMailAll" parameterType="map" resultType="MailVO">
    SELECT *
    FROM (
        SELECT mail_no, 
               sender_name,
               send_date,
               mail_title,
               ROWNUM AS rn
        FROM (
            SELECT m.mail_no, 
                   FIND_EMP_NAME(m.sender_id) AS sender_name,
                   m.send_date,
                   m.mail_title
            FROM mail m
            JOIN mail_receive mr ON m.mail_no = mr.mail_no
            WHERE mr.employee_id = #{mailVO.senderId}
            AND m.company_code = #{mailVO.companyCode}
            AND m.mail_status = 'IMPORT'
            <if test="criteria.searchType != null and criteria.searchType != ''">
                <if test="criteria.searchType == 'mailtitle'">
                    AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
                </if>
                <if test="criteria.searchType == 'senderId'">
                    AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
                </if>
            </if>
            ORDER BY m.mail_no DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{criteria.pageNum} * #{criteria.amount}
    )
    WHERE rn > (#{criteria.pageNum} - 1) * #{criteria.amount}
</select>

<select id="importMailTotalCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM mail m
    JOIN mail_receive mr ON m.mail_no = mr.mail_no
    WHERE mr.employee_id = #{mailVO.senderId}
    AND m.mail_status = 'IMPORT'
    <if test="criteria.searchType != null and criteria.searchType != ''">
        <if test="criteria.searchType == 'mailtitle'">
            AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
        </if>
        <if test="criteria.searchType == 'senderId'">
            AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
        </if>
    </if>
</select>


<!-- 휴지통 메일 조회 -->
<select id="deleteMailAll" parameterType="map" resultType="MailVO">
    SELECT *
    FROM (
        SELECT mail_no, 
               sender_name,
               send_date,
               mail_title,
               ROWNUM AS rn
        FROM (
            SELECT m.mail_no, 
                   FIND_EMP_NAME(m.sender_id) AS sender_name,
                   m.send_date,
                   m.mail_title
            FROM mail m
            JOIN mail_receive mr ON m.mail_no = mr.mail_no
            WHERE mr.employee_id = #{mailVO.senderId}
            AND m.company_code = #{mailVO.companyCode}
            AND m.mail_status = 'TRASH'
            <if test="criteria.searchType != null and criteria.searchType != ''">
                <if test="criteria.searchType == 'mailtitle'">
                    AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
                </if>
                <if test="criteria.searchType == 'senderId'">
                    AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
                </if>
            </if>
            ORDER BY m.mail_no DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{criteria.pageNum} * #{criteria.amount}
    )
    WHERE rn > (#{criteria.pageNum} - 1) * #{criteria.amount}
</select>

<select id="deleteMailTotalCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM mail m
    JOIN mail_receive mr ON m.mail_no = mr.mail_no
    WHERE mr.employee_id = #{mailVO.senderId}
    AND m.mail_status = 'TRASH'
    <if test="criteria.searchType != null and criteria.searchType != ''">
        <if test="criteria.searchType == 'mailtitle'">
            AND m.mail_title LIKE '%' || #{criteria.keyword} || '%'
        </if>
        <if test="criteria.searchType == 'senderId'">
            AND FIND_EMP_NAME(m.sender_id) LIKE '%' || #{criteria.keyword} || '%'
        </if>
    </if>
</select>

<!-- 휴지통 메일 조회 -->


	<!-- 중요 메일 조회
	<select id="importMailAll" parameterType="MailVO"
		resultType="MailVO">
		SELECT
		FIND_EMP_NAME(m.sender_id) AS sender_name,
		m.send_date,
		m.mail_title
		FROM mail m
		JOIN mail_receive mr ON m.mail_no = mr.mail_no
		WHERE mr.employee_id = #{employeeId}
		AND m.mail_status = 'IMPORT'
	</select>


	<select id="deleteMailAll" parameterType="MailVO"
		resultType="MailVO">
		SELECT
		FIND_EMP_NAME(m.sender_id) AS sender_name,
		m.send_date,
		m.mail_title
		FROM mail m
		JOIN mail_receive mr ON m.mail_no =
		mr.mail_no
		WHERE mr.employee_id = #{employeeId}
		AND m.mail_status =
		'TRASH'
	</select>
 -->
	<!-- 메일 상세 조회 -->
	<select id="selectMailInfo" parameterType="MailVO"
		resultType="MailVO">
		SELECT
		FIND_EMP_NAME(m.sender_id) AS sender_name,
		mr.employee_id AS receiver_id,
		m.mail_title,
		m.mail_content,
		m.send_date
		FROM mail m
		JOIN mail_receive mr ON m.mail_no = mr.mail_no
		WHERE m.mail_no = #{mailNo}
	</select>




<!-- 메일 전송 -->
<insert id="sendMail" parameterType="MailVO">
	<selectKey keyProperty="mailNo" order="BEFORE" resultType="int">
		SELECT 	MAIL_NO_SEQ.NEXTVAL 
		  FROM DUAL
	</selectKey>
    INSERT INTO mail (
        mail_no,
        sender_id,
        mail_title,
        mail_content,
        mail_status,
        company_code
    ) VALUES (
        #{mailNo},
        #{senderId},
        #{mailTitle},
        #{mailContent},
        'SEND',
        #{companyCode}
    )
</insert>

    <!-- 메일 수신자 정보 추가 -->
    <insert id="insertMailReceive" parameterType="MailReceiveVO">
   
     <selectKey keyProperty="receiveNo" order="BEFORE" resultType="int">
     SELECT 	RECEIVE_NO_SEQ.NEXTVAL 
		  FROM DUAL
     </selectKey>
        INSERT INTO mail_receive (
            receive_no,
            mail_no,
            employee_id,
            company_code
        ) VALUES (
            #{receiveNo},
            #{mailNo},
            #{employeeId},
            #{companyCode}
        )
    </insert>

</mapper>

