<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{common/group/layouts/group_layout}"
    layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>ARION</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <h1>기안서</h1>
    <form id="insertTemp" th:action="@{/insertTemp}" method="post" enctype="multipart/form-data">
        <label>문서종류</label>
        <input type="text" name="docType" required>
        <label>파일등록</label>
        <input type="file" name="files" onchange="previewHwpFile()">
        <div id="captureArea">
            <div id="previewArea">
                <!-- 파일 미리보기가 여기에 표시됩니다 -->
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-primary" onclick="captureAndSubmit()">등록</button>
        </div>
    </form>

    <script>
        function previewHwpFile() {
            const file = document.querySelector('input[name="files"]').files[0];
            const formData = new FormData();
            formData.append("file", file);

            $.ajax({
                type: "POST",
                url: "/previewHwp",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    document.getElementById('previewArea').innerHTML = response;
                },
                error: function(error) {
                    console.log("HWP 미리보기 실패", error);
                    document.getElementById('previewArea').innerHTML = "파일을 읽는 중 오류가 발생했습니다.";
                }
            });
        }

        function captureAndSubmit() {
            html2canvas(document.querySelector("#captureArea")).then(function(canvas) {
                canvas.toBlob(function(blob) {
                    const form = document.getElementById("insertTemp");
                    const formData = new FormData(form);

                    // 캡처된 이미지를 files 배열에 추가
                    formData.append("files", blob, "capture.png");

                    // AJAX를 사용해 FormData를 전송
                    $.ajax({
                        type: "POST",
                        url: form.action,
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            alert("폼이 성공적으로 제출되었습니다.");
                            window.location.href = "/group/doc/template";
                        },
                        error: function(error) {
                            alert("폼 제출 중 오류가 발생했습니다.");
                        }
                    });
                }, "image/png");
            });
        }
    </script>
</body>
</html>
